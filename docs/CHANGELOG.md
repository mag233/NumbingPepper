# Changelog

## Unreleased
- Docs: update phone scope (Writer-first, Reader/Library disabled with hint, chat overlay trigger, compact Settings entry; tablet deferred).
- Reader: add bookmark creation, list, edit title, and removal (per book).
- Reader: preserve position when switching Paged/Continuous; TOC jumps no longer force mode switches.
- Reader: paged navigation supports arrow keys and wheel-to-next/prev at edges; continuous prev/next controls now scroll to anchors.
- Writer: Rewrite tone submenu now shows custom tone labels from Settings.
- Writer: add a global search modal with filters for Content/Context/References/Chat/Studio and click-to-jump results.
- Settings: rewrite tone profiles enforce a 3-example/60-word limit and update tone labels immediately after save.
- Desktop: persist Reader/Writer left sidebar width; reset via Writer `Layout` controls.
- Desktop: replace “Hide navigation” text button with a compact icon toggle.
- Writer: restore visual distinction between user and AI chat bubbles.
- Desktop: add global `Layout/Done` toggle (Reader + Writer) with explicit scope hint and per-view Reset semantics (Task 37).
- Desktop (Reader): add Comfortable/Compact density in `Layout` adjust mode (Reader-only), persisted locally and reset via Reader Reset.
- Desktop layout: locked-mode dividers are non-draggable, and sidebar vs Reader↔Chat split gutters match in adjust mode.
- Writer: selection apply is a single-step Undo (mobile-friendly notice bar) after Replace/Insert.
- Writer: after applying a suggestion (Replace/Insert), briefly flash-highlight the newly inserted text (theme-aware); clears on next input or after 7s.
- Settings: add Writer AI Templates manager (Use defaults / Reset / Reset all) for selection actions.
- Writer: Rewrite tone profiles support in Settings (directive/description/examples), applied as extra prompt directives per tone.
- Writer: suggestion actions add `To Context`, and `Insert below` adds a blank line before inserted text for readability.
- Writer: fix a ghost Writer selection menu that could re-appear after selection clears and become non-clickable.
- Integrations: add Flomo export core (webhook POST + note builder) and a smoke script (`node scripts/flomo-smoke.mjs`).
- Settings: add an Integrations tab with Flomo webhook URL config + `Test & Save` (env `VITE_FLOMO_API` used as a default/placeholder).
- Integrations: add a “Send to Flomo” composer modal for Reader/Writer drafts; Writer Context defaults expanded on desktop and collapsible on mobile; tags are deduped and headings are English.
- Reader: selection menu adds `Note` which uses the Flomo composer (merged) to save a highlight note and optionally `Save & Send` to Flomo.
- Writer: selection bubble menu adds `Flomo` export for sending the selected snippet (plus Context) to Flomo.
- Flomo composer: add `Save & Close` and keep `Save` open; show local-only “Last sent” timestamp after successful sends.
- Writer: add `Flomo History` (local-only outbox) to review recent sends per project and quickly `Resend`.
- Settings (Reader): show the Questions output contract hint only within the Questions template editor (avoids a confusing “extra section”).
- Writer: added a locked-by-default `Layout` mode with draggable Editor↔Writer AI split (default 65/35, min widths 520/320), Comfortable/Compact density presets, and Reset; persists locally.
- Writer: UI polish—Content/Context are separate cards (65/35), Studio and Chat are separate cards, artifacts list is compact, Hide chat fully reclaims space, and fixed a card corner artifact caused by overflow clipping.
- Reader: added `Questions` shortcut (auto-send) and a Settings editor for Reader AI templates (Ask AI/Summarize/Explain/Questions) with `Use defaults` + reset controls.
- Desktop layout: moved Settings to a `⚙` drawer (Global/Reader/Chat tabs), moved Library into the left sidebar, and added a bottom PDF toolbar (Jump/Find/Zoom/Fit).
- Code discipline: added Zod validation for persisted JSON (templates/settings/books local fallback), split oversized TS modules to meet the 250-LOC rule, and removed eslint-disable suppressions by restructuring effects.
- Added SQLite migrations for books/highlights/chats/drafts/FTS; Tauri import command copies to per-book folders with hash/mtime/size metadata.
- Library store hydrates from DB, dedupes by hash, persists `last_read_position` (page+scroll+zoom+fit_mode), and uses base64/asset loading in app.
- Web imports store data URLs to survive refresh; web hides desktop-only entries to avoid broken previews and guides users to re-import on web.
- Reader: improved highlight geometry by merging selection fragments per line; merge overlapping highlights to avoid dark stacking.
- Reader: reduce highlight adjacent-line overlap by enforcing a small vertical gap between normalized line rects (Task 12.1 / 29.2).
- Highlights: click-to-select via hit-testing and a popover for recolor/delete/note/Ask AI/Summarize/Explain/Questions; added save feedback + delete confirm.
- Reader: anchored highlight overlays to a page-sized host so layout toggles (Show/Hide navigation) don’t shift highlights.
- Reader: continuous scroll uses progressive page rendering to reduce jank on large PDFs.
- Reader: zoom (buttons + Ctrl/⌘ shortcuts), fit modes (manual/fit width/fit page), and copy selection with newline cleanup.
- Reader: added Find-in-document (paged-mode search with next/prev and in-page highlighting).
- Reader: Find highlight now tracks an “active” hit (blue outline) and retries longer until the text layer is measurable to reduce “no highlight on first jump”.
- Reader: improve multi-column highlight splitting (detect center gutter even when the gap is small) to avoid filling the gutter.
- Known: some multi-column PDFs may still produce gutter-bridging highlight rects; tracked as `12-QA-009` in `docs/QA.md`.
- Chat: persist messages per book session (`session_id=book:{bookId}`) with localStorage fallback for web dev.
- Writer: persist TipTap draft per book (`drafts.id=book:{bookId}`) with debounce + flush on book switch; localStorage fallback for web dev.
- Logging: added local-only event logging with secret redaction and 7-day retention; stores to localStorage and to a `app_logs` SQLite table (created if missing).
- Docs: expanded Writer requirements in `docs/PRD.md`, added `docs/writer-srs.md`, and added Task 18 breakdown in `docs/TASKS.md` (Writer deferred until Task 29 complete).
- Reader/Chat: added per-panel error boundaries with a “Reload panel” recovery action (Task 29.1).
- Reader: show PDF outline/TOC (if present) in the left nav for quick page jumps (Task 29.4).
- Library: hash-based de-duplication on import (no extra copy), recent-open tracking, and safe deletion actions (remove vs delete local file) (Task 19).
- Library: added Trash/Restore (soft delete) to avoid “removed but app copy still exists” confusion; destructive delete now labeled as deleting the app copy (Task 19.6).
- Library: constrain library list height with scrolling; add selection-for-actions without switching the current preview (explicit Open to switch) (Task 19.7).
- Reader: drag-select now renders a custom selection overlay (per-line rects) and disables native PDF text-layer selection background to reduce adjacent-line overlap (Task 29.5).
- Reader: selection overlay filters out bogus large rects when dragging into whitespace (prevents “giant blue blocks”) (Task 29.5).
- Docs: expanded Writer workflow model (projects/content/context/references + Reader→Writer actions), added collapsible multi-round writer chat requirement, and refreshed Task 18 breakdown/backlogs.
- Reader: added PageLabels support (show printed page labels when available; Jump supports labels and `pdf:` physical override) (Task 28.6).
- Writer: added SQLite schema (migrations v10–v14) and TS/Zod contracts for projects/content/context/references (Task 18.1).
- Writer: added projects store + picker UI; Writer drafts are now project-scoped (no longer tied to Reader book selection) (Task 18.2).
- Writer: added project-scoped Context panel with persistence, Clear, and Undo last append (Task 18.3).
- Writer: project switching now re-initializes TipTap per project draft id to prevent cross-project content bleed; new projects load empty content by default (Task 18.3).
- Writer: added a per-project, collapsible Writer AI chat panel (separate from Reader book chat) with persistence and template dropdown scaffold (Task 18.6).
- Writer: Writer AI chat now uses left/right aligned bubbles with distinct styling for user vs assistant; collapsed state shrinks the chat column instead of leaving a large blank area.
- Writer: added hashtag extraction from project content (`#tag` / `#tag/subtag`) and a tag filter in the Projects picker (Task 18.7).
- Writer: added a Markdown Preview toggle (Edit/Preview) for Content; preview is read-only and preserves the source text (Task 18.8).
- Writer: added per-project References with manual add, include/exclude toggle, and safe delete (Task 18.4).
- Reader→Writer: persistent highlight popover adds “To Context” and “To Ref”, writing into the active project (with create-project prompt and undo for context append) (Task 18.5).
- Reader→Writer: selection floating menu now also includes “To Context” / “To Ref” (no need to persist highlight first); floating menu clamps horizontally to avoid the chat sidebar covering it.
- Theme: added preset-based theming (soft-dark/light/ocean/forest/sand) persisted in settings; app applies theme via CSS variables (Task 17).
- Theme: migrated remaining UI surfaces/text/borders to token-based colors (Reader/Writer/Chat/Library/menus) and refined Light preset accent/border for consistency.
- Writer: Context shows `chars` + `~tokens` with soft-limit warning; Writer AI templates support Insert (focuses input, no auto-send); desktop layout avoids global page scroll when top bar hidden.
- Process: added a strict “Suggestion vs Implementation Gate” to require explicit `Proceed` before any code/command changes.
- Docs: recorded Writer Content selection AI actions as a tracked requirement (Task 18.13) and added a QA placeholder (18-QA-015).
- Docs: specified Writer selection AI actions UX/spec (auto-send actions, draft-only Ask AI, Rewrite tone submenu, apply controls, template safety) and added QA rows (18-QA-023..029).
- Writer: replaced left ReaderNav with a WriterSidebar (Projects + References) when in Writer view; adjusted Content/Context sizing so Context isn't squeezed (Task 18.12).
- Writer: prevent Writer Projects dropdown from being covered by the editor; reduce desktop window scrolling by clamping the app shell to the viewport height.
- Writer: fix WriterSidebar header overflow by making the Projects controls wrap and constraining the Projects popover to the sidebar width.
- Writer: Projects picker closes via outside click/Esc/X; project creation requires explicit Save/Cancel to avoid accidental Untitled entries.
- Docs: refined Writer AI direction toward writing-first Studio artifacts (Kickoff/Definition/Explanation/Rewrite/Polish) with safe insert and citation constraint on by default (Task 18.15).
- Writer: implemented Studio artifacts (Kickoff/Definition/Explanation/Rewrite/Polish) saved per project; actions are non-destructive by default (generate → Artifact list → Insert/To Context/To Ref). Added `writing_artifacts` table (migration v15) with localStorage fallback on web.
- Writer: Studio artifacts list defaults to “Recent 3 + All…” to prevent the sidebar from crowding out chat; artifact action buttons are compact.
- Writer: disable TipTap horizontal-rule auto-conversion so `---` stays literal in Edit and renders correctly in Markdown Preview.
- Writer: Writer AI sidebar now keeps the chat input visible by making messages scroll and preventing the input form from taking flexible height; Studio is collapsible (default collapsed).
- Writer: added Writer outline (from markdown headings in Content) with click-to-jump, plus reference snippet expand/collapse and a wider Writer sidebar for readability.
- Writer: fix outline click-to-jump by wiring the editor to react to outline click events; improve multi-level rendering (indentation per heading level) and make jumps resilient to heading syntax variations.
- Writer: harden Writer draft persistence by writing through to local fallback on every save and flushing pending edits on pagehide/visibilitychange (reduces data loss on abrupt restarts).
- Writer: fix markdown normalization that incorrectly transformed `## Heading` into `# # Heading`, which broke Outline levels and preview rendering.
- Writer: fix autosave debounce bookkeeping and snapshot-based flush so the active project is not overwritten with an empty doc during app close/unmount.
- Writer: block autosave during editor hydration so switching Reader→Writer or switching projects cannot overwrite an existing draft with the initial empty editor state.
- Writer: if the user types before hydration finishes, cancel hydration and save to reduce data loss on slow loads.
- Fix: avoid a Writer crash in dev during draft hydration (invalidate in-flight hydration via sequence bump rather than adding a new hook).
- Writer: add explicit `Save` button + “Saved/Saving/Failed” status in the Writer header; harden SQLite init (fail-closed to local fallback) and persist content to `writing_contents` as a second-layer restore path.
