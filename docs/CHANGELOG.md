# Changelog

## Unreleased
- 2026-01-17: Docs: defined Library hub (Books/Projects/Tags), project management centralization, and reader sidebar scope-only requirements.
- 2026-01-17: Added project_books join table + local fallback, global project scope selector with persistent Global option, and Library/Reader project membership editor.
- 2026-01-17: Docs: split project/library scope work into Tasks 56-60 with detailed breakdowns.
- 2026-01-17: Docs: defined project-classifier scope (multi-project book assignment, scoped search, per-book reading position) and added Task 56/QA scaffolding.
- 2026-01-17: Reader restores last position on view return (page + scroll), tag edit popovers clamp to the viewport, and references no longer clear on tab switches.
- 2026-01-16: Reference tags now display title/author/year labels without the `ai_reader` prefix, References panel supports tag filtering with a system-tag toggle, system tags are styled as accent chips, user tags use action-positive chips, Reader To Ref prompts for optional tags with a clearer placeholder, and Context Clear offers context-only vs context+chat.
- 2026-01-16: Added explicit project/book tags with Flomo defaults (optional save-back) and a Writer full export (Content + Context) in the action bar.
- 2026-01-16: Tag editors now reset on project/book selection changes without effect-driven state updates; book tag persistence is exported through the DB barrel for consistency.
- 2026-01-16: Fixed Writer References panel store selector stability to avoid a React update depth loop in dev.
- 2026-01-16: Project/Book tags now display as chips with an Edit popover; references include toggle now uses a stable project id fallback.
- 2026-01-16: Writer references can be sent to Flomo from the References panel; reference export prefixes user tags with `#ai_reader/`.
- 2026-01-16: Removed Responses JSON output formatting control due to provider schema incompatibility; Responses settings now use text-only output.
- 2026-01-16: Added GPT-5 Responses API settings (reasoning/verbosity/max output tokens) with a safe Chat Completions/Responses toggle; chat calls can route to Responses API.
- 2026-01-16: Responses API input now sends plain text content for compatibility with providers that reject `input_text` content parts.
- 2026-01-15: Writer references now capture book metadata snapshots, store page labels, support tag editing with default tag toggles, and include APA 7 citation formatting in Writer artifacts prompts.
- 2026-01-15: Writer chat can include included reference snippets by default with a toggle; reference tags now support multi-line input and Source Info is shown separately.
- 2026-01-15: Writer chat now strips stale Context/References from history; clearing Context also clears Writer chat; reference tags now use `ai_reader/...` system tags with `#` display and hidden system tags in the editor.
- 2026-01-15: Reader To Ref now creates a Highlight before saving the Writer reference.
- 2026-01-15: Docs: updated Task 50/51 specs and QA coverage for tag namespace + Reader To Ref auto-highlight.
- 2026-01-15: Docs: define reference provenance metadata + APA 7 citation formatting, multimodal image chat support, and context image OCR flow with append/insert choice.
- 2026-01-15: Docs: add reference tags with system default tag generation (configurable) and search expectations.
- 2026-01-10: Matched mobile chat header button heights for Clear and Close.
- 2026-01-10: Split App shell UI into header/main/footer/overlay components to keep App.tsx under the size limit.
- 2026-01-10: Footer copy now reflects mobile chat overlay instead of a mobile chat tab.
- 2026-01-10: Moved App shell state/effects into `useAppShellState` for clearer logic/UIView separation.
- 2026-01-10: Centralized shell UI state (settings/nav/view/chat collapse/preview) in `uiStore` to reduce local state drift.
- 2026-01-10: Added status color tokens (warning/success/danger) and replaced hard-coded amber/red/emerald classes in UI status surfaces.
- 2026-01-10: Added dev-only scope assertions for Reader vs Writer chat sidebars.
- 2026-01-10: Added action hover tokens and replaced FloatingMenu hard-coded hover colors.
- 2026-01-10: Added highlight color tokens and replaced highlight popover/overlay hard-coded highlight colors.
- 2026-01-10: Softened ocean/forest theme surfaces, borders, and accents for a lighter feel.
- 2026-01-10: Updated app header icon and favicon to use the new `icon.png`.
- 2026-01-09: Centralized chat textarea sizing constants for mobile/desktop.
- 2026-01-09: Centralized chat form layout and submit controls to keep Reader/Writer consistent.
- 2026-01-09: Added a shared chat template selection hook to unify dropdown state.
- 2026-01-09: Centralized the mobile overlay shell for consistent layout and styling.
- 2026-01-09: Clarified chat template select behavior (Reader auto-applies; Writer selects only).
- 2026-01-09: Shared the chat context toggle control for consistent styling.
- 2026-01-09: Centralized chat template lookup for consistent dropdown behavior.
- 2026-01-09: Consolidated chat template lookup logic to avoid duplication.
- 2026-01-09: Shared chat template draft insertion logic between Reader and Writer.
- 2026-01-09: Cleaned up TipTap editor tests to avoid ProseMirror teardown errors.
- 2026-01-09: Shared chat panel body layout across Reader/Writer to reduce layout drift.
- 2026-01-09: Shared quick-prompt handling logic between Reader and Writer chat.
- 2026-01-09: Added explicit reader/writer chat scope props to avoid accidental store mixing.
- 2026-01-09: Standardized chat bubble class ordering via a shared helper to reduce role-style overrides.
- 2026-01-09: Consolidated chat error banner rendering across Reader/Writer chat panels.
- 2026-01-09: Consolidated chat message auto-scroll into a shared scroll container.
- 2026-01-09: Centralized the mobile breakpoint query into shared constants for consistent mobile detection.
- 2026-01-09: Mobile chat close button uses a consistent icon size in the overlay header.
- 2026-01-09: Mobile chat uses overlay-only entry on phone (chat tab removed); quick prompts open the overlay and it closes on desktop resize.
- Docs: update phone scope (Writer-first, Reader/Library disabled with hint, chat overlay trigger, compact Settings entry; tablet deferred).
- Docs: add planned Library enhancements (pop-out drawer + Recent reads summary, tags/folders/status, metadata extraction, Mark as Done action).
- Docs: add Reader/Writer chat visual parity requirement (consistent bubble styling across views).
- Writer: global search modal (Task 18.20) now keeps the draggable panel open, flashes jump targets across Content/Context/References/Chat, and persists the title-bar drag position with viewport clamping (2026-01-07).
- Writer: outline list stays visible in Preview mode with a read-only hint, and clicks scroll the rendered preview to the heading just like Edit mode (Task 18.16, 2026-01-07).
- Writer: reference preview expand/collapse working (Task 18.16, 2026-01-07).
- Reader: add bookmark creation, list, edit title, and removal (per book).
- Reader: preserve position when switching Paged/Continuous; TOC jumps no longer force mode switches.
- Reader: paged navigation supports arrow keys and wheel-to-next/prev at edges; continuous prev/next controls now scroll to anchors.
- Writer: Rewrite tone submenu now shows custom tone labels from Settings.
- Writer: add a global search modal with filters for Content/Context/References/Chat/Studio and click-to-jump results.
- Settings: rewrite tone profiles enforce a 3-example/60-word limit and update tone labels immediately after save.
- Desktop: persist Reader/Writer left sidebar width; reset via Writer `Layout` controls.
- Desktop: replace “Hide navigation” text button with a compact icon toggle.
- Writer: restore visual distinction between user and AI chat bubbles.
- Desktop: add global `Layout/Done` toggle (Reader + Writer) with explicit scope hint and per-view Reset semantics (Task 37).
- Desktop (Reader): add Comfortable/Compact density in `Layout` adjust mode (Reader-only), persisted locally and reset via Reader Reset.
- Desktop layout: locked-mode dividers are non-draggable, and sidebar vs Reader↔Chat split gutters match in adjust mode.
- Writer: selection apply is a single-step Undo (mobile-friendly notice bar) after Replace/Insert.
- Writer: after applying a suggestion (Replace/Insert), briefly flash-highlight the newly inserted text (theme-aware); clears on next input or after 7s.
- Settings: add Writer AI Templates manager (Use defaults / Reset / Reset all) for selection actions.
- Writer: Rewrite tone profiles support in Settings (directive/description/examples), applied as extra prompt directives per tone.
- Writer: suggestion actions add `To Context`, and `Insert below` adds a blank line before inserted text for readability.
- Writer: fix a ghost Writer selection menu that could re-appear after selection clears and become non-clickable.
- Integrations: add Flomo export core (webhook POST + note builder) and a smoke script (`node scripts/flomo-smoke.mjs`).
- Settings: add an Integrations tab with Flomo webhook URL config + `Test & Save` (env `VITE_FLOMO_API` used as a default/placeholder).
- Integrations: add a “Send to Flomo” composer modal for Reader/Writer drafts; Writer Context defaults expanded on desktop and collapsible on mobile; tags are deduped and headings are English.
- Reader: selection menu adds `Note` which uses the Flomo composer (merged) to save a highlight note and optionally `Save & Send` to Flomo.
- Writer: selection bubble menu adds `Flomo` export for sending the selected snippet (plus Context) to Flomo.
- Flomo composer: add `Save & Close` and keep `Save` open; show local-only “Last sent” timestamp after successful sends.
- Writer: add `Flomo History` (local-only outbox) to review recent sends per project and quickly `Resend`.
- Settings (Reader): show the Questions output contract hint only within the Questions template editor (avoids a confusing “extra section”).
- Writer: added a locked-by-default `Layout` mode with draggable Editor↔Writer AI split (default 65/35, min widths 520/320), Comfortable/Compact density presets, and Reset; persists locally.
- Writer: UI polish—Content/Context are separate cards (65/35), Studio and Chat are separate cards, artifacts list is compact, Hide chat fully reclaims space, and fixed a card corner artifact caused by overflow clipping.
- Reader: added `Questions` shortcut (auto-send) and a Settings editor for Reader AI templates (Ask AI/Summarize/Explain/Questions) with `Use defaults` + reset controls.
- Desktop layout: moved Settings to a `⚙` drawer (Global/Reader/Chat tabs), moved Library into the left sidebar, and added a bottom PDF toolbar (Jump/Find/Zoom/Fit).
- Code discipline: added Zod validation for persisted JSON (templates/settings/books local fallback), split oversized TS modules to meet the 250-LOC rule, and removed eslint-disable suppressions by restructuring effects.
- Added SQLite migrations for books/highlights/chats/drafts/FTS; Tauri import command copies to per-book folders with hash/mtime/size metadata.
- Library store hydrates from DB, dedupes by hash, persists `last_read_position` (page+scroll+zoom+fit_mode), and uses base64/asset loading in app.
- Web imports store data URLs to survive refresh; web hides desktop-only entries to avoid broken previews and guides users to re-import on web.
- Reader: improved highlight geometry by merging selection fragments per line; merge overlapping highlights to avoid dark stacking.
- Reader: reduce highlight adjacent-line overlap by enforcing a small vertical gap between normalized line rects (Task 12.1 / 29.2).
- Highlights: click-to-select via hit-testing and a popover for recolor/delete/note/Ask AI/Summarize/Explain/Questions; added save feedback + delete confirm.
- Reader: anchored highlight overlays to a page-sized host so layout toggles (Show/Hide navigation) don’t shift highlights.
- Reader: continuous scroll uses progressive page rendering to reduce jank on large PDFs.
- Reader: zoom (buttons + Ctrl/⌘ shortcuts), fit modes (manual/fit width/fit page), and copy selection with newline cleanup.
- Reader: added Find-in-document (paged-mode search with next/prev and in-page highlighting).
- Reader: Find highlight now tracks an “active” hit (blue outline) and retries longer until the text layer is measurable to reduce “no highlight on first jump”.
- Reader: improve multi-column highlight splitting (detect center gutter even when the gap is small) to avoid filling the gutter.
- Known: some multi-column PDFs may still produce gutter-bridging highlight rects; tracked as `12-QA-009` in `docs/QA.md`.
- Chat: persist messages per book session (`session_id=book:{bookId}`) with localStorage fallback for web dev.
- Writer: persist TipTap draft per book (`drafts.id=book:{bookId}`) with debounce + flush on book switch; localStorage fallback for web dev.
- Logging: added local-only event logging with secret redaction and 7-day retention; stores to localStorage and to a `app_logs` SQLite table (created if missing).
- Docs: expanded Writer requirements in `docs/PRD.md`, added `docs/writer-srs.md`, and added Task 18 breakdown in `docs/TASKS.md` (Writer deferred until Task 29 complete).
- Reader/Chat: added per-panel error boundaries with a “Reload panel” recovery action (Task 29.1).
- Reader: show PDF outline/TOC (if present) in the left nav for quick page jumps (Task 29.4).
- Library: hash-based de-duplication on import (no extra copy), recent-open tracking, and safe deletion actions (remove vs delete local file) (Task 19).
- Library: added Trash/Restore (soft delete) to avoid “removed but app copy still exists” confusion; destructive delete now labeled as deleting the app copy (Task 19.6).
- Library: constrain library list height with scrolling; add selection-for-actions without switching the current preview (explicit Open to switch) (Task 19.7).
- Reader: drag-select now renders a custom selection overlay (per-line rects) and disables native PDF text-layer selection background to reduce adjacent-line overlap (Task 29.5).
- Reader: selection overlay filters out bogus large rects when dragging into whitespace (prevents “giant blue blocks”) (Task 29.5).
- Docs: expanded Writer workflow model (projects/content/context/references + Reader→Writer actions), added collapsible multi-round writer chat requirement, and refreshed Task 18 breakdown/backlogs.
- Reader: added PageLabels support (show printed page labels when available; Jump supports labels and `pdf:` physical override) (Task 28.6).
- Writer: added SQLite schema (migrations v10–v14) and TS/Zod contracts for projects/content/context/references (Task 18.1).
- Writer: added projects store + picker UI; Writer drafts are now project-scoped (no longer tied to Reader book selection) (Task 18.2).
- Writer: added project-scoped Context panel with persistence, Clear, and Undo last append (Task 18.3).
- Writer: project switching now re-initializes TipTap per project draft id to prevent cross-project content bleed; new projects load empty content by default (Task 18.3).
- Writer: added a per-project, collapsible Writer AI chat panel (separate from Reader book chat) with persistence and template dropdown scaffold (Task 18.6).
- Writer: Writer AI chat now uses left/right aligned bubbles with distinct styling for user vs assistant; collapsed state shrinks the chat column instead of leaving a large blank area.
- Writer: added hashtag extraction from project content (`#tag` / `#tag/subtag`) and a tag filter in the Projects picker (Task 18.7).
- Writer: added a Markdown Preview toggle (Edit/Preview) for Content; preview is read-only and preserves the source text (Task 18.8).
- Writer: added per-project References with manual add, include/exclude toggle, and safe delete (Task 18.4).
- Reader→Writer: persistent highlight popover adds “To Context” and “To Ref”, writing into the active project (with create-project prompt and undo for context append) (Task 18.5).
- Reader→Writer: selection floating menu now also includes “To Context” / “To Ref” (no need to persist highlight first); floating menu clamps horizontally to avoid the chat sidebar covering it.
- Theme: added preset-based theming (soft-dark/light/ocean/forest/sand) persisted in settings; app applies theme via CSS variables (Task 17).
- Theme: migrated remaining UI surfaces/text/borders to token-based colors (Reader/Writer/Chat/Library/menus) and refined Light preset accent/border for consistency.
- Writer: Context shows `chars` + `~tokens` with soft-limit warning; Writer AI templates support Insert (focuses input, no auto-send); desktop layout avoids global page scroll when top bar hidden.
- Process: added a strict “Suggestion vs Implementation Gate” to require explicit `Proceed` before any code/command changes.
- Docs: recorded Writer Content selection AI actions as a tracked requirement (Task 18.13) and added a QA placeholder (18-QA-015).
- Docs: specified Writer selection AI actions UX/spec (auto-send actions, draft-only Ask AI, Rewrite tone submenu, apply controls, template safety) and added QA rows (18-QA-023..029).
- Writer: replaced left ReaderNav with a WriterSidebar (Projects + References) when in Writer view; adjusted Content/Context sizing so Context isn't squeezed (Task 18.12).
- Writer: prevent Writer Projects dropdown from being covered by the editor; reduce desktop window scrolling by clamping the app shell to the viewport height.
- Writer: fix WriterSidebar header overflow by making the Projects controls wrap and constraining the Projects popover to the sidebar width.
- Writer: Projects picker closes via outside click/Esc/X; project creation requires explicit Save/Cancel to avoid accidental Untitled entries.
- Docs: refined Writer AI direction toward writing-first Studio artifacts (Kickoff/Definition/Explanation/Rewrite/Polish) with safe insert and citation constraint on by default (Task 18.15).
- Writer: implemented Studio artifacts (Kickoff/Definition/Explanation/Rewrite/Polish) saved per project; actions are non-destructive by default (generate → Artifact list → Insert/To Context/To Ref). Added `writing_artifacts` table (migration v15) with localStorage fallback on web.
- Writer: Studio artifacts list defaults to “Recent 3 + All…” to prevent the sidebar from crowding out chat; artifact action buttons are compact.
- Writer: disable TipTap horizontal-rule auto-conversion so `---` stays literal in Edit and renders correctly in Markdown Preview.
- Writer: Writer AI sidebar now keeps the chat input visible by making messages scroll and preventing the input form from taking flexible height; Studio is collapsible (default collapsed).
- Writer: added Writer outline (from markdown headings in Content) with click-to-jump, plus reference snippet expand/collapse and a wider Writer sidebar for readability.
- Writer: fix outline click-to-jump by wiring the editor to react to outline click events; improve multi-level rendering (indentation per heading level) and make jumps resilient to heading syntax variations.
- Writer: harden Writer draft persistence by writing through to local fallback on every save and flushing pending edits on pagehide/visibilitychange (reduces data loss on abrupt restarts).
- Writer: fix markdown normalization that incorrectly transformed `## Heading` into `# # Heading`, which broke Outline levels and preview rendering.
- Writer: fix autosave debounce bookkeeping and snapshot-based flush so the active project is not overwritten with an empty doc during app close/unmount.
- Writer: block autosave during editor hydration so switching Reader→Writer or switching projects cannot overwrite an existing draft with the initial empty editor state.
- Writer: if the user types before hydration finishes, cancel hydration and save to reduce data loss on slow loads.
- Fix: avoid a Writer crash in dev during draft hydration (invalidate in-flight hydration via sequence bump rather than adding a new hook).
- Writer: add explicit `Save` button + “Saved/Saving/Failed” status in the Writer header; harden SQLite init (fail-closed to local fallback) and persist content to `writing_contents` as a second-layer restore path.

## 0.1.1 - 2026-01-09
- Writer: save status uses draft persistence as the source of truth; avoid reporting failure when project content write-through fails.
- Writer: add manual snapshots/history persistence in SQLite with local fallback (create/restore/duplicate/delete).
- Docs: add contribution, security, support, and privacy files; refresh README release guidance.
