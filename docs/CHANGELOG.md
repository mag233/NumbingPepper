# Changelog

## Unreleased
- Added SQLite migrations for books/highlights/chats/drafts/FTS; Tauri import command copies to per-book folders with hash/mtime/size metadata.
- Library store hydrates from DB, dedupes by hash, persists `last_read_position` (page+scroll+zoom+fit_mode), and uses base64/asset loading in app.
- Web imports store data URLs to survive refresh; web hides desktop-only entries to avoid broken previews and guides users to re-import on web.
- Reader: improved highlight geometry by merging selection fragments per line; merge overlapping highlights to avoid dark stacking.
- Reader: reduce highlight adjacent-line overlap by enforcing a small vertical gap between normalized line rects (Task 12.1 / 29.2).
- Highlights: click-to-select via hit-testing and a popover for recolor/delete/note/Ask AI/Summarize/Explain/Questions; added save feedback + delete confirm.
- Reader: anchored highlight overlays to a page-sized host so layout toggles (Show/Hide navigation) don’t shift highlights.
- Reader: continuous scroll uses progressive page rendering to reduce jank on large PDFs.
- Reader: zoom (buttons + Ctrl/⌘ shortcuts), fit modes (manual/fit width/fit page), and copy selection with newline cleanup.
- Reader: added Find-in-document (paged-mode search with next/prev and in-page highlighting).
- Reader: Find highlight now tracks an “active” hit (blue outline) and retries longer until the text layer is measurable to reduce “no highlight on first jump”.
- Known: multi-column PDFs can still produce gutter-bridging highlight rects; tracked as a non-blocker in `docs/QA.md`.
- Chat: persist messages per book session (`session_id=book:{bookId}`) with localStorage fallback for web dev.
- Writer: persist TipTap draft per book (`drafts.id=book:{bookId}`) with debounce + flush on book switch; localStorage fallback for web dev.
- Logging: added local-only event logging with secret redaction and 7-day retention; stores to localStorage and to a `app_logs` SQLite table (created if missing).
- Docs: expanded Writer requirements in `docs/PRD.md`, added `docs/writer-srs.md`, and added Task 18 breakdown in `docs/TASKS.md` (Writer deferred until Task 29 complete).
- Reader/Chat: added per-panel error boundaries with a “Reload panel” recovery action (Task 29.1).
- Reader: show PDF outline/TOC (if present) in the left nav for quick page jumps (Task 29.4).
- Library: hash-based de-duplication on import (no extra copy), recent-open tracking, and safe deletion actions (remove vs delete local file) (Task 19).
- Library: added Trash/Restore (soft delete) to avoid “removed but app copy still exists” confusion; destructive delete now labeled as deleting the app copy (Task 19.6).
- Library: constrain library list height with scrolling; add selection-for-actions without switching the current preview (explicit Open to switch) (Task 19.7).
- Reader: drag-select now renders a custom selection overlay (per-line rects) and disables native PDF text-layer selection background to reduce adjacent-line overlap (Task 29.5).
- Reader: selection overlay filters out bogus large rects when dragging into whitespace (prevents “giant blue blocks”) (Task 29.5).
- Docs: expanded Writer workflow model (projects/content/context/references + Reader→Writer actions), added collapsible multi-round writer chat requirement, and refreshed Task 18 breakdown/backlogs.
- Reader: added PageLabels support (show printed page labels when available; Jump supports labels and `pdf:` physical override) (Task 28.6).
- Writer: added SQLite schema (migrations v10–v14) and TS/Zod contracts for projects/content/context/references (Task 18.1).
- Writer: added projects store + picker UI; Writer drafts are now project-scoped (no longer tied to Reader book selection) (Task 18.2).
- Writer: added project-scoped Context panel with persistence, Clear, and Undo last append (Task 18.3).
- Writer: project switching now re-initializes TipTap per project draft id to prevent cross-project content bleed; new projects load empty content by default (Task 18.3).
- Writer: added a per-project, collapsible Writer AI chat panel (separate from Reader book chat) with persistence and template dropdown scaffold (Task 18.6).
- Writer: Writer AI chat now uses left/right aligned bubbles with distinct styling for user vs assistant; collapsed state shrinks the chat column instead of leaving a large blank area.
- Writer: added hashtag extraction from project content (`#tag` / `#tag/subtag`) and a tag filter in the Projects picker (Task 18.7).
- Writer: added a Markdown Preview toggle (Edit/Preview) for Content; preview is read-only and preserves the source text (Task 18.8).
- Writer: added per-project References with manual add, include/exclude toggle, and safe delete (Task 18.4).
- Reader→Writer: persistent highlight popover adds “To Context” and “To Ref”, writing into the active project (with create-project prompt and undo for context append) (Task 18.5).
- Reader→Writer: selection floating menu now also includes “To Context” / “To Ref” (no need to persist highlight first); floating menu clamps horizontally to avoid the chat sidebar covering it.
- Theme: added preset-based theming (soft-dark/light/ocean/forest/sand) persisted in settings; app applies theme via CSS variables (Task 17).
- Theme: migrated remaining UI surfaces/text/borders to token-based colors (Reader/Writer/Chat/Library/menus) and refined Light preset accent/border for consistency.
- Writer: Context shows `chars` + `~tokens` with soft-limit warning; Writer AI templates support Insert (focuses input, no auto-send); desktop layout avoids global page scroll when top bar hidden.
- Process: added a strict “Suggestion vs Implementation Gate” to require explicit `Proceed` before any code/command changes.
- Docs: recorded Writer Content selection AI actions as a tracked requirement (Task 18.13) and added a QA placeholder (18-QA-015).
- Writer: replaced left ReaderNav with a WriterSidebar (Projects + References) when in Writer view; adjusted Content/Context sizing so Context isn't squeezed (Task 18.12).
- Writer: prevent Writer Projects dropdown from being covered by the editor; reduce desktop window scrolling by clamping the app shell to the viewport height.
- Writer: fix WriterSidebar header overflow by making the Projects controls wrap and constraining the Projects popover to the sidebar width.
- Writer: Projects picker closes via outside click/Esc/X; project creation requires explicit Save/Cancel to avoid accidental Untitled entries.
- Docs: refined Writer AI direction toward writing-first Studio artifacts (Kickoff/Definition/Explanation/Rewrite/Polish) with safe insert and citation constraint on by default (Task 18.15).
- Writer: implemented Studio artifacts (Kickoff/Definition/Explanation/Rewrite/Polish) saved per project; actions are non-destructive by default (generate → Artifact list → Insert/To Context/To Ref). Added `writing_artifacts` table (migration v15) with localStorage fallback on web.
